<div class="containter">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <div class="form-group">
          <label for="namespace">SERVICE</label>
          <input type="text" class="form-control" id="service-name" placeholder="New service name...">
        </div>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="col-md-6 col-md-offset-2">
        <strong>When creating new service, you'll require to add default configurations</strong>
      </div>
    </div>
    <hr>        
    <div class="row">
      <div class="col-md-2 col-md-offset-2">
        <button class="btn btn-info" id="add-more">Add New Default Key +</button>
      </div>
    </div>
    <br>
    <div class="row" id="key-value-data">
      <div class="col-md-4 col-md-offset-2">
        <div class="form-group">
          <label for="key">KEY</label>
          <input type="text" id="key-1" class="form-control key" name="key" placeholder="New key...">
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <label for="value">VALUE</label>
          <input type="text" id="value-1" class="form-control value" name="value" placeholder="New value...">
        </div>
      </div>
    </div>
    <div class="row">
        <div class="col-md-4 col-md-offset-2">
        <div class="form-group">
          <button class="btn btn-success col-md-4" id="save-config-button">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    var index = 2;
    $("#add-more").click(function(e) {
      $("#key-value-data").append(`
        <div id="keyform-${index}" class="col-md-4 col-md-offset-2">
          <div class="form-group">
            <input type="text" id="key-${index}" class="form-control key" name="key" placeholder="New key...">
          </div>
        </div>
        <div id="valueform-${index}" class="col-md-4">
          <div class="form-group">
            <input type="text" id="value-${index}" class="form-control value" name="value" placeholder="New value...">
          </div>
        </div>
        <div id="removeform-${index}" class="col-md-2">
          <div class="form-group">
            <button id="remove-${index}" class="btn btn-danger remove-key"> X </button>
          </div>
        </div>
      `)
      index = index+1

      $(".remove-key").click(function(e) {
        var fieldNum = this.id.charAt(this.id.length-1)
        $(this).remove()
        $(`#removeform-${fieldNum}`).remove()
        $(`#keyform-${fieldNum}`).remove()
        $(`#valueform-${fieldNum}`).remove()
      })
    });

    $("#save-config-button").click(function(e) {
      let keys = document.querySelectorAll('.key')
      let values = document.querySelectorAll('.value')
      let arrKeys = parseNodeList(keys)
      let arrValues = parseNodeList(values)
      let jsonConfigs = {}

      for (let i = 0; i < arrKeys.length; i++) {
        jsonConfigs[arrKeys[i]] = arrValues[i]
      }

      axios({
        method: 'post',
        url: '/service/new',
        data: {
          name: $("#service-name").val()
        },
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
          'Content-Type': 'application/json'
        }
      }).then(() => {
        axios({
          method: 'post',
          url: '/namespace/new',
          data: {
            servicename: $("#service-name").val(),
            namespace: "default",
            configurations: jsonConfigs
          },
          headers: {
            'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
            'Content-Type': 'application/json'
          }
        }).then(() => {
          window.location.replace(`http://localhost:3000/namespace/${$("#service-name").val()}`);   
        }).catch((err) => {
          console.log(err)
        })
      }).catch((err) => {
        console.log(err)
      })
    })

    function parseNodeList(nodeName) {
      let arrReturn = []
      nodeName.forEach.call(nodeName, function(node) {
        arrReturn.push(node.value)
      })

      return arrReturn
    }
  });

</script>
